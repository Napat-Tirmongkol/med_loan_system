<?php
// 1. "จ้างยามมาเฝ้าประตู"
include('includes/check_session.php'); //
// 2. เรียกใช้ไฟล์เชื่อมต่อ DB
require_once('db_connect.php'); //

// (โค้ดส่วนตรวจสอบ $_GET message ... ยังคงเดิม)
$message = '';
$message_type = '';
if (isset($_GET['add']) && $_GET['add'] == 'success') {
    $message = 'เพิ่มประเภทอุปกรณ์ใหม่สำเร็จ!';
    $message_type = 'success';
} elseif (isset($_GET['edit']) && $_GET['edit'] == 'success') {
    $message = 'แก้ไขข้อมูลประเภทอุปกรณ์สำเร็จ!';
    $message_type = 'success';
} 
// ( ... โค้ด Error handling อื่นๆ ... )

// 4. ตั้งค่าตัวแปรสำหรับหน้านี้
$page_title = "จัดการประเภทอุปกรณ์"; // ◀️ (แก้ไขชื่อ)
$current_page = "manage_equip";
// 5. เรียกใช้ไฟล์ Header
include('includes/header.php');

// 6. ◀️ (แก้ไข) ดึงข้อมูลจากตาราง "ประเภท" (types)
try {
    // ◀️ (SQL แก้ไข) เปลี่ยนจาก med_equipment เป็น med_equipment_types
    $sql = "SELECT * FROM med_equipment_types";

    $conditions = [];
    $params = [];

    $search_query = $_GET['search'] ?? '';
    // $status_query = $_GET['status'] ?? ''; // (ตาราง Types ไม่มี status)

    if (!empty($search_query)) {
        $search_term = '%' . $search_query . '%';
        $conditions[] = "(name LIKE ? OR description LIKE ?)"; // ◀️ (SQL แก้ไข)
        $params[] = $search_term;
        $params[] = $search_term;
    }

    if (count($conditions) > 0) {
        $sql .= " WHERE " . implode(" AND ", $conditions);
    }

    $sql .= " ORDER BY name ASC";

    $stmt = $pdo->prepare($sql);
    $stmt->execute($params);
    $equipment_types = $stmt->fetchAll(PDO::FETCH_ASSOC); // ◀️ (แก้ไขชื่อตัวแปร)

} catch (PDOException $e) {
    echo "เกิดข้อผิดพลาดในการดึงข้อมูล: " . $e->getMessage();
    $equipment_types = [];
}
?>

<?php if ($message): ?>
    <div style="padding: 15px; margin-bottom: 20px; border-radius: 4px; color: #fff; background-color: <?php echo ($message_type == 'success') ? 'var(--color-success)' : 'var(--color-danger)'; ?>;">
        <?php echo $message; ?>
    </div>
<?php endif; ?>

<div class="header-row">
    <h2><i class="fas fa-tools"></i> จัดการประเภทอุปกรณ์</h2>
    <?php if (isset($_SESSION['role']) && $_SESSION['role'] == 'admin'): ?>
        <button class="add-btn" onclick="openAddTypePopup()">
            <i class="fas fa-plus"></i> เพิ่มประเภทอุปกรณ์
        </button>
    <?php endif; ?>
</div>

<div class="filter-row">
    <form action="manage_equipment.php" method="GET" style="display: contents;">
        <label for="search_term">ค้นหา:</label>
        <input type="text" name="search" id="search_term" value="<?php echo htmlspecialchars($search_query); ?>" placeholder="ชื่อประเภท/รายละเอียด">

        <button type="submit" class="btn btn-return"><i class="fas fa-filter"></i> กรอง</button>
        <a href="manage_equipment.php" class="btn btn-secondary"><i class="fas fa-times"></i> ล้างค่า</a>
    </form>
</div>


<div class="table-container desktop-only">
    <table>
        <thead>
            <tr>
                <th style="width: 70px;">รูปภาพ</th>
                <th>ชื่อประเภทอุปกรณ์</th>
                <th>รายละเอียด</th>
                <th>จำนวน (ว่าง/ทั้งหมด)</th>
                <th style="width: 250px;">จัดการ</th> </tr>
        </thead>
        <tbody>
            <?php if (empty($equipment_types)): ?>
                <tr>
                    <td colspan="5" style="text-align: center;">ไม่พบข้อมูลประเภทอุปกรณ์</td>
                </tr>
            <?php else: ?>
                <?php foreach ($equipment_types as $type): ?>
                    <tr>
                        <td>
                            <?php if (!empty($type['image_url'])): ?>
                                <img src="<?php echo htmlspecialchars($type['image_url']); ?>"
                                    alt="รูป"
                                    style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;"
                                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                                <div class="equipment-card-image-placeholder" style="display: none; width: 50px; height: 50px; font-size: 1.5rem;"><i class="fas fa-image"></i></div>
                            <?php else: ?>
                                <div class="equipment-card-image-placeholder" style="width: 50px; height: 50px; font-size: 1.5rem;">
                                    <i class="fas fa-camera"></i>
                                </div>
                            <?php endif; ?>
                        </td>
                        <td><?php echo htmlspecialchars($type['name']); ?></td>
                        <td style="white-space: pre-wrap;"><?php echo htmlspecialchars($type['description'] ?? '-'); ?></td>
                        <td>
                            <strong style="color: var(--color-success);"><?php echo $type['available_quantity']; ?></strong> / <?php echo $type['total_quantity']; ?>
                        </td>
                        <td class="action-buttons">
                            <?php if ($_SESSION['role'] == 'admin'): ?>
                                <a href="manage_items.php?type_id=<?php echo $type['id']; ?>" class="btn btn-borrow">
                                    <i class="fas fa-list-ol"></i> จัดการรายชิ้น
                                </a>
                                
                                <button type="button" class="btn btn-manage" style="margin-left: 5px;" onclick="openEditTypePopup(<?php echo $type['id']; ?>)">แก้ไข</button>

                                <button type="button"
                                    class="btn btn-danger"
                                    style="margin-left: 5px;"
                                    onclick="confirmDeleteType(<?php echo $type['id']; ?>, '<?php echo htmlspecialchars(addslashes($type['name'])); ?>')">ลบ</button>
                            <?php endif; ?>
                        </td>
                    </tr>
                <?php endforeach; ?>
            <?php endif; ?>
        </tbody>
    </table>
</div>

<div class="student-card-list">
    <?php if (empty($equipment_types)): ?>
        <div class="history-card">
            <p style="text-align: center; width: 100%;">ไม่พบข้อมูลประเภทอุปกรณ์</p>
        </div>
    <?php else: ?>
        <?php foreach ($equipment_types as $type): ?>
            <div class="history-card">

                <div class="history-card-icon">
                    <?php if (!empty($type['image_url'])): ?>
                        <img src="<?php echo htmlspecialchars($type['image_url']); ?>" alt="รูป" style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                        <div class="equipment-card-image-placeholder" style="display: none; width: 40px; height: 40px; font-size: 1.2rem;"><i class="fas fa-image"></i></div>
                    <?php else: ?>
                        <div class="equipment-card-image-placeholder" style="width: 40px; height: 40px; font-size: 1.2rem;">
                            <i class="fas fa-camera"></i>
                        </div>
                    <?php endif; ?>
                </div>

                <div class="history-card-info">
                    <h4 class="truncate-text" title="<?php echo htmlspecialchars($type['name']); ?>">
                        <?php echo htmlspecialchars($type['name']); ?>
                    </h4>
                    <p>จำนวน: 
                        <strong style="color: var(--color-success);"><?php echo $type['available_quantity']; ?></strong> / <?php echo $type['total_quantity']; ?>
                    </p>
                </div>

                <div class="pending-card-actions">
                    <?php if ($_SESSION['role'] == 'admin'): ?>
                        <a href="manage_items.php?type_id=<?php echo $type['id']; ?>" class="btn btn-borrow" style="margin-left: 0;">
                            <i class="fas fa-list-ol"></i> จัดการ
                        </a>
                        <button type="button" class="btn btn-manage" onclick="openEditTypePopup(<?php echo $type['id']; ?>)">แก้ไข</button>
                        <button type="button" class="btn btn-danger" onclick="confirmDeleteType(<?php echo $type['id']; ?>, '<?php echo htmlspecialchars(addslashes($type['name'])); ?>')">ลบ</button>
                    <?php endif; ?>
                </div>

            </div>
        <?php endforeach; ?>
    <?php endif; ?>
</div>


<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // ◀️ (แก้ไข) เปลี่ยนฟังก์ชัน openAddEquipmentPopup เป็น openAddTypePopup
    // และเปลี่ยนไฟล์ที่เรียกเป็น add_type_process.php (ไฟล์ใหม่)
    function openAddTypePopup() {
        Swal.fire({
            title: '➕ เพิ่มประเภทอุปกรณ์ใหม่',
            html: `
            <form id="swalAddTypeForm" style="text-align: left; margin-top: 20px;">
                <div style="margin-bottom: 15px;">
                    <label for="swal_type_name" style="font-weight: bold; display: block; margin-bottom: 5px;">ชื่อประเภท:</label>
                    <input type="text" name="name" id="swal_type_name" required style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="swal_type_desc" style="font-weight: bold; display: block; margin-bottom: 5px;">รายละเอียด:</label>
                    <textarea name="description" id="swal_type_desc" rows="3" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="swal_type_image_file" style="font-weight: bold; display: block; margin-bottom: 5px;">แนบรูปภาพ (ถ้ามี):</label>
                    <input type="file" name="image_file" id="swal_type_image_file" accept="image/*" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
                </div>
                </form>`,
            width: '600px',
            showCancelButton: true,
            confirmButtonText: 'บันทึกประเภทใหม่',
            cancelButtonText: 'ยกเลิก',
            confirmButtonColor: 'var(--color-success, #28a745)',
            focusConfirm: false,
            preConfirm: () => {
                const form = document.getElementById('swalAddTypeForm');
                const name = form.querySelector('#swal_type_name').value;
                if (!name) {
                    Swal.showValidationMessage('กรุณากรอกชื่อประเภทอุปกรณ์');
                    return false;
                }
                
                // ◀️ (แก้ไข) เรียกไฟล์ process ใหม่
                return fetch('add_type_process.php', {
                        method: 'POST',
                        body: new FormData(form)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status !== 'success') throw new Error(data.message);
                        return data;
                    })
                    .catch(error => {
                        Swal.showValidationMessage(`เกิดข้อผิดพลาด: ${error.message}`);
                    });
            }
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire('เพิ่มสำเร็จ!', 'เพิ่มประเภทอุปกรณ์ใหม่เรียบร้อย', 'success').then(() => location.href = 'manage_equipment.php?add=success');
            }
        });
    }

    // ◀️ (ลบ) ฟังก์ชัน confirmDeleteEquipment (ย้ายไปไฟล์ใหม่)
    // ◀️ (ลบ) ฟังก์ชัน openEditPopup (ย้ายไปไฟล์ใหม่)
    
    // ◀️ (ใหม่) ฟังก์ชันสำหรับ "ลบ" ประเภท
    function confirmDeleteType(typeId, typeName) {
        Swal.fire({
            title: "คุณแน่ใจหรือไม่?",
            text: `คุณกำลังจะลบประเภท "${typeName}" (จะลบได้ต่อเมื่อไม่มีอุปกรณ์รายชิ้นในประเภทนี้)`,
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            // ... (โค้ด JS สำหรับเรียก delete_type_process.php) ...
        });
        // (หมายเหตุ: เรายังไม่ได้สร้างไฟล์ delete_type_process.php)
    }

    // ◀️ (ใหม่) ฟังก์ชันสำหรับ "แก้ไข" ประเภท
    function openEditTypePopup(typeId) {
        // ... (โค้ด JS สำหรับเรียก get_type_data.php และ edit_type_process.php) ...
    }
</script>

<?php
// 7. เรียกใช้ไฟล์ Footer
include('includes/footer.php');
?>