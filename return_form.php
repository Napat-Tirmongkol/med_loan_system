<?php
// 1. "‡∏à‡πâ‡∏≤‡∏á‡∏¢‡∏≤‡∏°" ‡πÅ‡∏•‡∏∞ "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ DB"
include('includes/check_session.php');
require_once('db_connect.php');

// 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin
if (!isset($_SESSION['role']) || $_SESSION['role'] != 'admin') {
    header("Location: index.php");
    exit;
}

// ----- ‡∏™‡πà‡∏ß‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -----
$equipment_id = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$transaction_data = null;

if ($equipment_id == 0) {
    die("‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏ ID ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå <a href='index.php'>‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>");
}

try {
    $sql = "SELECT 
                t.id as transaction_id, t.borrow_date, t.due_date,
                e.name as equipment_name, e.serial_number as equipment_serial,
                b.full_name as borrower_name, b.contact_info as borrower_contact
            FROM med_transactions t
            JOIN med_equipment e ON t.equipment_id = e.id
            JOIN med_borrowers b ON t.borrower_id = b.id
            WHERE t.equipment_id = ? AND t.status = 'borrowed'
            ORDER BY t.borrow_date DESC 
            LIMIT 1"; 
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$equipment_id]);
    $transaction_data = $stmt->fetch(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    die("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " . $e->getMessage());
}

if (!$transaction_data) {
    echo "<h1>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ</h1>";
    echo "<a href='index.php'>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>";
    exit;
}
// ----- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -----

$page_title = "‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå";
$current_page = "return"; 
include('includes/header.php');
?>

<div class="container">
    <h2>üì¶ ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>

    <div style="background: #f4f4f4; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</h3>
        <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</strong> <?php echo htmlspecialchars($transaction_data['equipment_name']); ?></p>
        <p><strong>‡πÄ‡∏•‡∏Ç‡∏ã‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏•:</strong> <?php echo htmlspecialchars($transaction_data['equipment_serial']); ?></p>
        <hr>
        <p><strong>‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°:</strong> <?php echo htmlspecialchars($transaction_data['borrower_name']); ?> (<?php echo htmlspecialchars($transaction_data['borrower_contact']); ?>)</p>
        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°:</strong> <?php echo date('d/m/Y H:i', strtotime($transaction_data['borrow_date'])); ?></p>
        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô:</strong> <?php echo date('d/m/Y', strtotime($transaction_data['due_date'])); ?></p>
    </div>

    <form action="return_process.php" method="POST" id="returnForm">
        
        <input type="hidden" name="transaction_id" value="<?php echo $transaction_data['transaction_id']; ?>">
        <input type="hidden" name="equipment_id" value="<?php echo $equipment_id; ?>">

        <p style="font-weight: bold; color: #dc3545;">
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô
        </p>

        <div>
            <button type="button" onclick="confirmReturn()" class="btn btn-return" style="font-size: 16px;">
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô
            </button>
            <a href="index.php" class="btn" style="background-color: #6c757d;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</a>
        </div>
    </form>
</div>


<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function confirmReturn() {
    // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤ (‡∏ú‡∏°‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏ö‡∏ó)
    Swal.fire({
        title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô?",
        text: "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "‡πÉ‡∏ä‡πà, ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
        cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
    }).then((result) => {
        if (result.isConfirmed) {
            // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏™‡∏±‡πà‡∏á Submit ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ id 'returnForm'
            document.getElementById('returnForm').submit();
        }
    });
}
</script>

<?php
// 6. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Footer
include('includes/footer.php'); 
?>